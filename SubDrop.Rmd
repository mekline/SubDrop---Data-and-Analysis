---
title: "Analysis Record - SubDrop Kids project"
author: "Melissa <<mekline@mit.edu>>"
date: "`r Sys.Date()`"
output:
  tufte::tufte_html: default
liftr:
  from: "rocker/r-base:latest"
  maintainer: "Nan Xiao"
  email: "me@nanx.me"
  cran:
    - tufte
    - kernlab
---

# SubDrop Analysis document

Here is (will be) the pipeline for executing all code to get you from subdrop_reconciled.csv to all analyses reported in the paepr

Technical note: This is an R Markdown document that could be rendered under a Docker container using `liftr`. See [this page](https://liftr.me/articles/liftr-intro.html) for instructions on installing Docker and getting the corresponding R markdown output. 

## Preliminaries

(Code is suppressed here for the most part; see the RMD file if interested). It loads all the libraries,
```{r load_libraries, include=FALSE}
library(irr)
library(stringr)
#library(languageR) #Might be deprecated?
library(lme4)
library(multcomp)
library(binom)
library(dplyr)
library(lsr)
library(EMT)
library(ggplot2)
library(bootstrap)
library(liftr)
library(tufte)
```
makes some convenience functions,
```{r custom-funs, include=FALSE}
mean.na.rm <- function(x) { mean(x,na.rm=T) }
sum.na.rm <- function(x) { sum(x,na.rm=T) }
stderr <- function(x) sqrt(var(x)/length(x))
bootup <- function(mylist){
  foo <- bootstrap(mylist, 1000, mean)
  return(quantile(foo$thetastar, 0.975)[1])
}
bootdown <- function(mylist){
  foo <- bootstrap(mylist, 1000, mean)
  return(quantile(foo$thetastar, 0.025)[1])
}

```
and loads the data
```{r load-data, include=FALSE}
#Get directory of this file
directory = getwd()
subtable = data.frame(NULL)
subtable = read.csv(paste0(directory, "/SubDrop_reconciled.csv"), header = TRUE, stringsAsFactors = FALSE)
```
Check here to see that your data was loaded:
```{r check-data}
head(subtable[,1:10], n=3)
```

## Data cleaning

So boring, so necessary. Relabeling columns and fixing factor/character encoding issues. 

```{r data-clean, include=FALSE}

#Fix some badly formatted columns
subtable$Kid.Response.A...Prag.Choice. <- as.character (subtable$Kid.Response.A...Prag.Choice.)
subtable$Kid.Response.B...Prag.Choice. <- as.character (subtable$Kid.Response.B...Prag.Choice.)
subtable$Gender <- subtable$Gender..Guessed.from.Name.Appearance.

subtable[is.na(subtable)] <- 0

#Fix age calculations!
subtable$Age.Years <- as.numeric(as.character(subtable$Age.Years))
subtable$Days.Old <- as.numeric(as.character(subtable$Days.Old))

####################################
#Pick subset of data to analyze (experiment, kids included)

#Choose 'ParentSecret' and 'ParentSecretControl' study versions
subtable <- subtable[subtable$Experiment == "ParentSecret" | subtable$Experiment == "ParentSecretControl" | subtable$Experiment == "ParentSecretControl2" ,]
subtable[subtable$Experiment ==  "ParentSecretControl2",]$Experiment <- "ParentSecretControl"

#chose stricter inclusion criteria.., following new paradigm rules dropped <- subtable[subtable$Final.Include == 0,]
dropped <- subtable[subtable$Final.Include == 0,]

subtable <- subtable[subtable$Final.Include == 1,]

#who & why excluded from analysis?
```

Here is a full report on how many rows are dropped from the analyzed dataset and why. It's principally  bilingualism, reported developmental delay, error with consent/no consent, age outside the intended sample (but tested anyhow because children's museum) A note on "ExpErrorJ": A series of major implementation flaws (e.g. puppets did not see the events they were supposedly describing) were discovered after several months :( - RA implementation was very inconsistently implemented so a large # of participants must be excluded)

```{r drop-table}
table(dropped$Final.Reason, dropped$Experiment)
```

This is followed by yet more data cleaning. One major note: We tried 2-trial (between-subj) and 4-trial (within-subj) versions of the task. With within-subj 4-trial version, we saw big carryover effects during data collection. So, we only ever analyzed just the 1st 2 trials, treating this data as a between-subjects comparison.

```{r data-clean-2, include=FALSE}
# Recode condition variables

#SD: 'subject drop' is the 'correct answer', other name for this condition is 'two fruits'
#OD: aka 'two animals'

#

subtable$oldCond <- subtable$Condition
subtable[subtable$Condition == "SDOD",]$Condition <- "SD"
subtable[subtable$Condition == "SDSD",]$Condition <- "SD"
subtable[subtable$Condition == "ODSD",]$Condition <- "OD"
subtable[subtable$Condition == "ODOD",]$Condition <- "OD"

## Code Correctness!  For main experiment, correctness = chose the pragmatic one; For cont, correctness = chose the correct one! (this is the same! wrong answers differ though)

subtable$isPragChoiceA <- "NA"
subtable[subtable$Condition == "SD" & subtable$Kid.Response.A...Prag.Choice. == "eat orange",]$isPragChoiceA <- 1
subtable[subtable$Condition == "OD" & subtable$Kid.Response.A...Prag.Choice. == "monkey eat",]$isPragChoiceA <- 1
subtable[subtable$Condition == "SD" & subtable$Kid.Response.A...Prag.Choice. == "monkey eat",]$isPragChoiceA <- 0
subtable[subtable$Condition == "OD" & subtable$Kid.Response.A...Prag.Choice. == "eat orange",]$isPragChoiceA <- 0
subtable[subtable$Condition == "SD" & subtable$Kid.Response.A...Prag.Choice. == "eat banana",]$isPragChoiceA <- 0
subtable[subtable$Condition == "OD" & subtable$Kid.Response.A...Prag.Choice. == "duck eat",]$isPragChoiceA <- 0

subtable$isPragChoiceB <- "NA"
subtable[subtable$Condition == "SD" & subtable$Kid.Response.B...Prag.Choice. == "pet dog",]$isPragChoiceB <- 1
subtable[subtable$Condition == "OD" & subtable$Kid.Response.B...Prag.Choice. == "girl pet",]$isPragChoiceB <- 1
subtable[subtable$Condition == "SD" & subtable$Kid.Response.B...Prag.Choice. == "girl pet",]$isPragChoiceB <- 0
subtable[subtable$Condition == "OD" & subtable$Kid.Response.B...Prag.Choice. == "pet dog",]$isPragChoiceB <- 0
subtable[subtable$Condition == "SD" & subtable$Kid.Response.B...Prag.Choice. == "pet cat",]$isPragChoiceB <- 0
subtable[subtable$Condition == "SD" & subtable$Kid.Response.B...Prag.Choice. == "pet kitty",]$isPragChoiceB <- 0 #lexical alternative!
subtable[subtable$Condition == "OD" & subtable$Kid.Response.B...Prag.Choice. == "boy pet",]$isPragChoiceB <- 0

#A few kis didn't answer on one trial and will need to be manually dropped
subtable <- subtable[subtable$isPragChoiceA != "NA",]
subtable <- subtable[subtable$isPragChoiceB != "NA",]
subtable$isPragChoiceA <- as.numeric(as.character(subtable$isPragChoiceA))
subtable$isPragChoiceB <- as.numeric(as.character(subtable$isPragChoiceB))



#Express this as # chose 'correct' across experiment
subtable$pragChoiceScore <- subtable$isPragChoiceA + subtable$isPragChoiceB

#...Or as # chose to drop the object
subtable$choseObjectDrop <- subtable$pragChoiceScore
subtable[subtable$Condition == "SD",]$choseObjectDrop <- 2-subtable[subtable$Condition == "SD",]$pragChoiceScore


```

## Descriptive statistics

Just a code block for now
```{r descriptive-stats}
####################################
#Descriptive stats for graphing (Developmental, small sample, so we'll present hist. of kids choosing each asnwer, rather than proportion scores)

#Time to split up the kids into Main and Control experiments 

maintable <- subtable[subtable$Experiment == "ParentSecret",] 
conttable <- subtable[subtable$Experiment == "ParentSecretControl" | subtable$Experiment == "ParentSecretControl2",] 

#Toss older/younger accidental participant from conttable, it's just for 3-4yos
conttable <- conttable[conttable$Age.Years < 5,]
conttable <- conttable[conttable$Age.Years > 2,]
```

(End of doc, tech details below...)

## Session information

The R session information for compiling this document is shown below.

```{r session}
sessionInfo()
```
